<!DOCTYPE html>
<html>
  <head>
    <title>Device Properties Example</title>

    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var devices = {};
        var socket = io.connect(location.href);
        socket.on('connect', function(client){
                console.log('connect');
        });
        socket.on('init_devices', function (data) {
                console.log(data);
                if (typeof data.devices == "string") {
                    devices[data.devices]={active:true, loading:false};
                }
                else {
                data.devices.forEach(function(e){
                    devices[e]={active:true, loading:false};
                });
                }
         });
         socket.on('disconnect', function(){
                console.log('disconnect');
        }); 
    </script>
    <script type="text/javascript" charset="utf-8">

    // Wait for Cordova to load
    //
    document.addEventListener("deviceready", onDeviceReady, false);

    var watchID = null;

    // Cordova is ready
    //
    function onDeviceReady() {
        // Throw an error if no update is received every 30 seconds
        var options = { timeout: 300 };
        watchID = navigator.geolocation.watchPosition(onSuccess, onError, options);
    }

    // onSuccess Geolocation
    //
    var oldvalue = null;
    function isSameAsOldValue(newval) {
        var ret=true;
        if (oldvalue == null) {
            ret=false;
            oldvalue = newval;
        } else {
            for (c in newval) {
                if (oldvalue[c] != newval[c]) {
                    ret = false;
                    oldvalue = newval;
                    return ret;
                }
            }
        }
        return ret;
    }
    
    function onSuccess(position) {
        if (isSameAsOldValue(oldvalue, position.coords)) return;
        var element = document.getElementById('geolocation');
        element.innerHTML = 'Latitude: '  + position.coords.latitude      + '<br />' +
                            'Longitude: ' + position.coords.longitude     + '<br />' +
                            '<hr />' ;//     + element.innerHTML;
        console.log(position.coords);
        for(c in devices) {
                socket.emit('message',{device:c, data:position.coords})
        }
    }

    // onError Callback receives a PositionError object
    //
    function onError(error) {
        alert('code: '    + error.code    + '\n' +
              'message: ' + error.message + '\n');
    }

    </script>
  </head>
  <body>
    <p id="geolocation">Watching geolocation...</p>
  </body>
</html>
